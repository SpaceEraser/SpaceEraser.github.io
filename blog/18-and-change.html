---
program_dividers: [6, 10, 16, 20, 23, 29, 34, 38]
hr_zones:
  recovery: 70
  aerobic: 75
  long: 80
  long-plus: 84
  tempo: 87
  speed: 94
  tune-up: 100
  race: 100
program:
  - ["core & yoga", "-", "5w<br/>5x3w/1r<br/>5w", "core", "5w<br/>5x3w/1r<br/>5w", "-", "5w<br/>5x2.5w<br/>1.5r/5w"]
  - ["core & yoga", "-", "4w<br/>5x2.5w/1.5r<br/>4w", "core", "4w<br/>5x2w/2r<br/>4w", "-", "4w<br/>3x2W/2R<br/>1x3w/6r<br/>4w"]
  - ["core & yoga", "-", "4w<br/>6x2w/2r<br/>4w", "core", "4W<br/>6x1.5w/2.5r<br/>4W", "-", "4W<br/>2km<br/>4W"]
  - ["core & yoga", "-", "4R<br/>6x1.5w/2.5r<br/>4W", "core", "4R<br/>6x1w/3r<br/>4W", "-", "4W<br/>3km<br/>4W"]
  - ["core & yoga", "-", "5R<br/>4x1w/5r<br/>5W", "core", "5R<br/>4x1w/7r<br/>5W", "-", "4W<br/>4km<br/>4W"]
  - ["core & yoga", "-", "5R<br/>5x1w/7r<br/>5W", "core", "5R<br/>3x1w/10r<br/>5W", "-", "5km"]

  - ["yoga", "3km", "3km", "yoga", "3km", "-", "3km"]
  - ["yoga", "3km", "3km", "yoga", "3km", "-", "4km"]
  - ["yoga", "3km", "3km", "yoga", "4km", "-", "5km"]
  - ["yoga", "2km", "2km", "yoga", "2km", "-", "3km"]

  - ["core & yoga", "4km", "4km", "core", "3km", "-", "4km"]
  - ["core & yoga", "4km", "4km", "core", "4km", "-", "5km"]
  - ["core & yoga", "20:00 intervals", "5km", "core", "5km", "-", "6km"]
  - ["core & yoga", "30:00 intervals", "6km", "core", "6km", "-", "7km"]
  - ["core & yoga", "40:00 intervals", "7km", "core", "6km", "-", "8km"]
  - ["core & yoga", "5km", "20:00 intervals", "core", "20:00 intervals", "-", "10km"]

  - ["yoga", "6km", "6km", "yoga", "6km", "-", "6km"]
  - ["yoga", "6km", "6km", "yoga", "7km", "-", "8km"]
  - ["yoga", "7km", "7km", "yoga", "8km", "-", "6km"]
  - ["yoga", "5km", "5km", "yoga", "5km", "-", "5km"]

  - ["-", "6km", "strength", "6km", "strength", 5km", "10km"]
  - ["-", "6km", "strength", "6km", "strength", 5km", "8km"]
  - ["-", "5km", "strength", "5km", "strength", 5km", "5km"]

  - ["-", ["tempo","13km","50% at HMP"], "-", ["aerobic","14km"], "-", ["recovery","6km"], ["long","19km"]]
  - ["-", ["aerobic","13km","strides"], "-", ["aerobic","16km"], "-", ["recovery","8km"], ["long-plus","21km","60% at MP"]]
  - ["-", ["aerobic","16km"], ["recovery","6km"], ["tempo","13km","50% at HMP"], "-", ["recovery","6km"], ["long","23km"]]
  - ["-", ["aerobic","13km","strides"], ["recovery"], ["aerobic","16km"], "-", ["recovery","6km"], ["long","24km"]]
  - ["-", ["tempo","14km","50% at HMP"], ["recovery","8km"], ["aerobic","16km"], "-", ["recovery","8km"], ["long","26km","60% at MP"]]
  - ["-", ["aerobic","13km","strides"], ["recovery","8km"], ["aerobic","13km"], "-", ["recovery","6km"], ["long","19km"]]

  - ["-", ["tempo","16km","50% at HMP"], ["recovery","6km"], ["long","18km"], "-", ["aerobic","11km","strides"], ["long","29km"]]
  - ["-", ["recovery","11km","strides"], ["long","19km"], "-", ["tempo","16km","60% at HMP"], ["recovery","8km"], ["long","32km"]]
  - ["-", ["recovery","10km"], ["long","23km"], ["recovery","10km"], "-", ["recovery","10km","strides"], ["long","26km","75% at MP"]]
  - ["-", ["aerobic","13km","strides"], ["speed","13km","5x800m intervals"], ["recovery","8km"], "-", ["aerobic","13km","strides"], ["long","23km"]]
  - ["-", ["recovery","11km","strides"], ["tempo","18km","60% at HMP"], "-", ["long","19km"], ["recovery","8km"], ["long","32km"]]

  - ["-", ["speed","13km","5x600m intervals"], ["long","19km"], "-", ["recovery","8km","strides"], ["tune-up","21km"], ["long","27km"]]
  - ["-", ["aerobic","13km"], ["speed","14km","5x1000m intervals"], "-", ["long","19km","strides"], ["recovery","8km"], ["long-plus","29km","75% at MP"]]
  - ["-", ["speed","13km","5x600m intervals"], ["long","18km"], "-", ["recovery","6km","strides"], ["tune-up","21km"], ["long","27km"]]
  - ["-", ["recovery","11km","strides"], ["speed","16km","5x1200m intervals"], "-", ["long","18km"], ["recovery","6km"], ["long","32km"]]

  - ["-", ["speed","13km","5x600m intervals"], ["recovery","10km"], "-", ["recovery","6km"], ["tune-up","15km"], ["long","26km"]]
  - ["-", ["aerobic","11km","strides"], ["speed","13km","3x1200m intervals"], "-", ["recovery","8km","strides"], "-", ["long","19km"]]
  - ["-", ["recovery","10km"], ["aerobic","11km","25% at MP"], "-", ["recovery","8km","strides"], ["recovery","6km"], ["race","42.2km"]]
---
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    table {
      border-collapse: collapse;
    }
    table thead tr:nth-child(1) {
      background: white;
      position: sticky;
      top: 0;
    }
    table tbody tr td {
      vertical-align: middle;
    }
    table tbody tr td:first-child {
      cursor: pointer;
    }
    .this-week {
      background-color: rgba(0, 0, 0, 0.25) !important;
    }
    .today {
      background-color: rgba(0, 0, 0, 0.5) !important;
      color: white;
    }
    td.recovery {
      background-color: #CFE2F3;
    }
    td.aerobic {
      background-color: #FFF2CC;
    }
    td.long {
      background-color: #D9D2E9;
    }
    td.long-plus {
      background-color: #D9D2E9;
    }
    td.tempo {
      background-color: #F4CCCC;
    }
    td.speed {
      background-color: #E6B8AF;
    }
    td.tune-up {
      background-color: #D5A6BD;
    }
    td.race {
      background-color: #D5A6BD;
    }
  </style>

  <title>18 & Change</title>
</head>

<body>
  <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <div class="container-md mb-3">
    <div class="row">
      <div class="col-12 text-center">
        <h1 class="mt-2">18 & Change</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        Non-negotiables:
        <ol>
          <li>STRETCH AFTER EVERY SESSION</li>
          <li>DON'T NEGLECT STRENGTH AND CONDITIONING</li>
          <li>RESPECT THE REST & RECOVERY</li>
        </ol>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-4 col-md-6 col-xs-12 mb-2">
        <form action="javascript:void(0);" class="">
          <div class="form-group d-flex">
            <label for="date" class="col-form-label text-end me-2">Race&nbsp;Date (week&nbsp;of)</label>
            <div class="flex-grow-1">
              <input id="date" name="date" type="date" class="form-control">
            </div>
          </div>
        </form>
      </div>
      <div class="col-lg-4 col-md-6 col-xs-12 mb-2">
        <form action="javascript:void(0);" class="">
          <div class="form-group d-flex">
            <label for="pace" class="col-form-label text-end me-2">Pace</label>
            <div class="flex-grow-1">
              <div class="input-group">
                <input id="pace" name="pace" type="pace" class="form-control" placeholder="00:00">
                <span class="input-group-text">min/km</span>
                <!-- <select class="selectpicker form-control" data-live-search="true">
                  <option value="km">min/km</option>
                  <option value="mi">min/mi</option>
                </select> -->
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="col-lg-4 col-md-6 col-xs-12 mb-2">
        <form action="javascript:void(0);" class="">
          <div class="form-group d-flex">
            <label for="maxhr" class="col-form-label text-end me-2">Max&nbsp;HR</label>
            <div class="flex-grow-1">
              <div class="input-group">
                <input id="maxhr" name="maxhr" type="maxhr" class="form-control" placeholder="190">
                <span class="input-group-text">bpm</span>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <table class="table table-bordered table-sm text-center mt-4"
          data-toggle="table" data-sticky-header="true">
          <thead>
            <tr>
              <th scope="col">Week</th>
              <th scope="col">Monday</th>
              <th scope="col">Tuesday</th>
              <th scope="col">Wednesday</th>
              <th scope="col">Thursday</th>
              <th scope="col">Friday</th>
              <th scope="col">Saturday</th>
              <th scope="col">Sunday</th>
            </tr>
          </thead>
          <tbody>
            {%- assign week_num = 1 -%}
            {% for week in page.program -%}
              <tr {%- for divider in page.program_dividers -%}{%- if divider == week_num %} style="border-bottom: solid 2px;"{%- endif -%}{%- endfor -%}>
                <td>#{{ week_num }}</td>
                {%- for day in week -%}
                  {%- if day[0] -%}
                    <td class="{{- day[0] -}}" {%- for hrz in page.hr_zones -%}{%- if hrz[0] == day[0] %} data-pace-pct="{{- hrz[1] -}}"{%- endif -%}{%- endfor -%}>
                    {{- day[0] | capitalize -}}
                    {%- if day[1] -%}<br/>{{- day[1] -}}{%- endif -%}
                    {%- if day[2] -%}<br/><span class="fst-italic">{{- day[2] -}}</span>{%- endif -%}
                  {%- else -%}
                    <td>
                    {{- day -}}
                  {%- endif -%}
                </td>
                {%- endfor -%}
              </tr>
              {%- assign week_num = week_num | plus: 1 -%}
            {% endfor %}
        </table>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-20">
          <div class="card-body">
            <h5 class="card-title">20:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">5 MINUTE EASY JOG WARM UP</li>
            <li class="list-group-item">10 X 30 SECONDS HARD RUNNING / 30 SECONDS SLOW JOG OR WALK</li>
            <li class="list-group-item">5 MINS EASY COOL DOWN</li>
          </ul>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-30">
          <div class="card-body">
            <h5 class="card-title">30:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">1KM EASY JOG WARM UP</li>
            <li class="list-group-item">5 X 30S EASY/20S TEMPO/10S HARD</li>
            <li class="list-group-item">2 MINS WALK</li>
            <li class="list-group-item">5 X 30S EASY/20S TEMPO/ 10S HARD</li>
            <li class="list-group-item">2 MINS WALK</li>
            <li class="list-group-item">5 X 30S EASY/20S TEMPO/ 10S HARD</li>
            <li class="list-group-item">2 MINS WALK</li>
            <li class="list-group-item">1KM COOL DOWN EASY JOG</li>
          </ul>
        </div>
      </div>  
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-40">
          <div class="card-body">
            <h5 class="card-title">40:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">10 MINUTE EASY JOG WARM UP</li>
            <li class="list-group-item">5 X 3 MINS HARD RUN / 1 MINS SLOW JOG OR WALK</li>
            <li class="list-group-item">10 MINS EASY JOG WALK COOL DOWN</li>
          </ul>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-50">
          <div class="card-body">
            <h5 class="card-title">50:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">10 MINS EASY JOG WARM UP</li>
            <li class="list-group-item">4 X 5 MINS AT TEMPO (7 OR 8/10 RPE) WITH 2.5MINS RECOVERY BETWEEN EACH</li>
            <li class="list-group-item">10 MINS EASY JOG COOL DOWN</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <pre>
          TODO: link to pace equivalency calculator for 5km (hard running) time
          (ex: https://lukehumphreyrunning.com/hmmcalculator/race_equivalency_calculator.php)
        </pre>
      </div>
    </div>
  </div>
  <script>
    $(function() {
      "use strict";

      const date_cookie = getCookie("date");
      const pace_cookie = getCookie("pace");
      const maxhr_cookie = getCookie("maxhr");
      let date = null;
      let pace = null;
      let maxhr = null;

      if (getCookie("countdown") === "true") {
        swapCountdowns();
      }

      if (date_cookie) {
        $('#date').val(date_cookie);
        date = deserializeDate(date_cookie);
        updateHighlight(date);
      }

      if (pace_cookie) {
        $('#pace').val(pace_cookie);
        pace = deserializeTime(pace_cookie);
        updatePace(pace, maxhr);
      }

      if (maxhr_cookie) {
        $('#maxhr').val(maxhr_cookie);
        maxhr = parseInt(maxhr_cookie, 10);
        updatePace(pace, maxhr);
      }

      $('#date').on('change', function() {
        const date_str = $(this).val();
        date = deserializeDate(date_str);
        setCookie('date', date_str, 365);
        updateHighlight(date);
      });

      $('#pace').on('change', function() {
        const pace_str = $(this).val();
        pace = deserializeTime(pace_str);
        if (isNaN(pace)) return;
        setCookie('pace', pace_str, 365);
        updatePace(pace, maxhr);
      });

      $('#maxhr').on('change', function() {
        const maxhr_str = $(this).val();
        maxhr = parseInt(maxhr_str, 10);
        if (isNaN(maxhr)) return;
        setCookie('maxhr', maxhr_str, 365);
        updatePace(maxhr, maxhr);
      });

      $('table tbody tr td:first-child').on('click', () => {
        setCookie("countdown", getCookie("countdown") == "false", 365);
        swapCountdowns();
      });

      setInterval(function () {
        updateHighlight(date);
      }, 1000 * 60 * 60); // repeat every hour
    });

    function formatTime(seconds) {  
      let t = [];
      const h = Math.floor(seconds / 3600);
      if (h > 0)
        t.push(h);
      const m = Math.floor((seconds % 3600) / 60);
      if (m > 0 || t.length > 0)
        t.push(`${m}`.padStart(1 + (t.length > 0), '0'));
      const s = seconds % 60;
      if (s > 0 || t.length > 0)
        t.push(`${s}`.padStart(1 + (t.length > 0), '0'));
      return t.join(':');
    }

    function deserializeTime(time) {
      const t = time.split(':');
      return parseFloat(t.pop()||'0') +
        parseInt(t.pop()||'0', 10)*60 +
        parseInt(t.pop()||'0', 10)*3600;
    }

    function swapCountdowns() {
      const program_num_weeks = $("table tbody tr").length;

      for (const el of $('table tbody tr td:first-child')) {
        const $el = $(el);
        const text_match = $el.text().match(/(-|#)?(\d+)/);
        const num = parseInt(text_match[2], 10);
        const inverse_num = program_num_weeks - num;
        if (text_match[1] === '#') {
          $el.text(`${inverse_num == 0 ? '' : '-'}${inverse_num}`);
        } else {
          $el.text(`#${inverse_num}`);
        }
      }
    }

    function updatePace(pace_s, maxhr) {
      $("table tbody tr td .distance-addon").remove();

      if (!Number.isFinite(pace_s)) {
        return;
      }

      for (const el of $("table tbody tr td")) {
        const $el = $(el);
        const pace_pct = parseFloat($el.data('pace-pct') || '75');
        const text_nodes = $el.find(":not(iframe)").addBack().contents().filter((_i, el) => el.nodeType === 3);
        for (const text_node of text_nodes) {
          const text_match = text_node.nodeValue.match(/(\d+(?:\.\d+)?)km/);
          if (!text_match)
            continue;
          let pace = pace_s * (100.0 / pace_pct);
          let time = parseFloat(text_match[1]) * pace;
          let addon = `${formatTime(Math.ceil(time))}, ${formatTime(Math.ceil(pace))}&nbsp;min/km`;
          if (maxhr) {
            addon += `, ❤️&#8288;${Math.ceil(maxhr * (pace_pct / 100.0))}`;
          }
          
          // TODO: this replaces the entire text node, not just the match
          $(text_node).replaceWith(`${text_match[1]}km<span class="distance-addon"> (${addon})</span>`);
        }
      }
    }

    function updateHighlight(date) {
      $(".today, .this-week").removeClass("today").removeClass("this-week");
      
      if (!(date instanceof Date)) {
        return;
      } 

      const now = new Date();
      const program_num_weeks = $("table tbody tr").length;
      const next_monday_after_date = addDays(date, 7 - mod(date.getDay()-1, 7));
      const program_start_ts = next_monday_after_date.getTime() - (program_num_weeks * 1000 * 60 * 60 * 24 * 7);
      const elapsed_days = (now.getTime() - program_start_ts) / (1000 * 60 * 60 * 24);
      const elapsed_weeks = Math.ceil(elapsed_days / 7);
      const elapsed_dow = Math.floor(elapsed_days) % 7;

      if (elapsed_days < 0 || elapsed_weeks > program_num_weeks) {
        return;
      }

      const $this_week = $(`table tbody tr:nth-child(${elapsed_weeks})`).addClass("this-week");
      $this_week.find(`td:nth-child(${elapsed_dow+2})`).addClass("today");
    }

    function mod(v, m) {
      return ((v % m) + m) % m;
    }

    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    function deserializeDate(str) {
      const [year, month, date] = str.split("-");
      return new Date(year, month - 1, date);
    }

    function setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + (exdays*24*60*60*1000));
      let expires = "expires="+ d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return null;
    }
  </script>
</body>

</html>