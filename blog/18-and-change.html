---
program_dividers: [6, 10, 16, 20, 23, 29, 34, 38]
hr_zones:
  recovery: 70
  aerobic: 75
  long: 80
  long-plus: 84
  tempo: 87
  speed: 94
  tune-up: 100
  race: 100
program:
  - ["Core & Yoga", "-", ["5w","5x3w/1r","5w"], "Core", ["5w","5x3w/1r","5w"], "-", ["5w","5x2.5w","1.5r/5w"]]
  - ["Core & Yoga", "-", ["4w","5x2.5w/1.5r", "4w"], "Core", ["4w","5x2w/2r", "4w"], "-", ["4w","3x2W/2R","1x3w/6r","4w"]]
  - ["Core & Yoga", "-", ["4w","6x2w/2r","4w"], "Core", ["4W","6x1.5w/2.5r","4W"], "-", ["4W","2km","4W"]]
  - ["Core & Yoga", "-", ["4R","6x1.5w/2.5r","4W"], "Core", ["4R","6x1w/3r","4W"], "-", ["4W","3km","4W"]]
  - ["Core & Yoga", "-", ["5R","4x1w/5r","5W"], "Core", ["5R","4x1w/7r","5W"], "-", ["4W","4km","4W"]]
  - ["Core & Yoga", "-", ["5R","5x1w/7r","5W"], "Core", ["5R","3x1w/10r","5W"], "-", {d: "5km"}]

  - ["Yoga", {d: "3km"}, {d: "3km"}, "Yoga", {d: "3km"}, "-", {d: "3km"}]
  - ["Yoga", {d: "3km"}, {d: "3km"}, "Yoga", {d: "3km"}, "-", {d: "4km"}]
  - ["Yoga", {d: "3km"}, {d: "3km"}, "Yoga", {d: "4km"}, "-", {d: "5km"}]
  - ["Yoga", {d: "2km"}, {d: "2km"}, "Yoga", {d: "2km"}, "-", {d: "3km"}]

  - ["Core & Yoga", {d: "4km"}, {d: "4km"}, "Core", {d: "3km"}, "-", {d: "4km"}]
  - ["Core & Yoga", {d: "4km"}, {d: "4km"}, "Core", {d: "4km"}, "-", {d: "5km"}]
  - ["Core & Yoga", "20:00 intervals", {d: "5km"}, "Core", {d: "5km"}, "-", {d: "6km"}]
  - ["Core & Yoga", "30:00 intervals", {d: "6km"}, "Core", {d: "6km"}, "-", {d: "7km"}]
  - ["Core & Yoga", "40:00 intervals", {d: "7km"}, "Core", {d: "6km"}, "-", {d: "8km"}]
  - ["Core & Yoga", {d: "5km"}, "20:00 intervals", "Core", "20:00 intervals", "-", {d: "10km"}]

  - ["Yoga", {d: "6km"}, {d: "6km"}, "Yoga", {d: "6km"}, "-", {d: "6km"}]
  - ["Yoga", {d: "6km"}, {d: "6km"}, "Yoga", {d: "7km"}, "-", {d: "8km"}]
  - ["Yoga", {d: "7km"}, {d: "7km"}, "Yoga", {d: "8km"}, "-", {d: "6km"}]
  - ["Yoga", {d: "5km"}, {d: "5km"}, "Yoga", {d: "5km"}, "-", {d: "5km"}]

  - ["Yoga", {n: "aerobic", d: "6km"}, "Strength", {n: "aerobic", d: "6km"}, {n: "aerobic", d: "6km"}, {n: "recovery", d: "5km"}, {n: "tune-up", d: "10km"}]
  - ["Yoga", {n: "aerobic", d: "6km"}, {n: "aerobic", d: "6km"}, {n: "aerobic", d: "5km"}, "Strength", {n: "recovery", d: "5km"}, {n: "aerobic", d: "8km"}]
  - ["Yoga", {n: "aerobic", d: "5km"}, {n: "aerobic", d: "6km"}, {n: "aerobic", d: "5km"}, "Strength", {n: "recovery", d: "5km"}, {n: "aerobic", d: "5km"}]

  - ["Yoga", {n: "tempo", d: "13km", s: "50% at HMP"}, "-", {n: "aerobic", d: "14km"}, "-", {n: "recovery", d: "6km"}, {n: "long", d: "19km"}]
  - ["Yoga", {n: "aerobic", d: "13km", s: "strides"}, "-", {n: "aerobic", d: "16km"}, "-", {n: "recovery", d: "8km"}, {n: "long-plus", d: "21km", s: "60% at MP"}]
  - ["Yoga", {n: "aerobic", d: "16km"}, {n: "recovery", d: "6km"}, {n: "tempo", d: "13km", s: "50% at HMP"}, "-", {n: "recovery", d: "6km"}, {n: "long", d: "23km"}]
  - ["Yoga", {n: "aerobic", d: "13km", s: "strides"}, {n: "recovery"}, {n: "aerobic", d: "16km"}, "-", {n: "recovery", d: "6km"}, {n: "long", d: "24km"}]
  - ["Yoga", {n: "tempo", d: "14km", s: "50% at HMP"}, {n: "recovery", d: "8km"}, {n: "aerobic", d: "16km"}, "-", {n: "recovery", d: "8km"}, {n: "long", d: "26km", s: "60% at MP"}]
  - ["Yoga", {n: "aerobic", d: "13km", s: "strides"}, {n: "recovery", d: "8km"}, {n: "aerobic", d: "13km"}, "-", {n: "recovery", d: "6km"}, {n: "long", d: "19km"}]

  - ["Yoga", {n: "tempo", d: "16km", s: "50% at HMP"}, {n: "recovery", d: "6km"}, {n: "long", d: "18km"}, "-", {n: "aerobic", d: "11km", s: "strides"}, {n: "long", d: "29km"}]
  - ["Yoga", {n: "recovery", d: "11km", s: "strides"}, {n: "long", d: "19km"}, "-", {n: "tempo", d: "16km", s: "60% at HMP"}, {n: "recovery", d: "8km"}, {n: "long", d: "32km"}]
  - ["Yoga", {n: "recovery", d: "10km"}, {n: "long", d: "23km"}, {n: "recovery", d: "10km"}, "-", {n: "recovery", d: "10km", s: "strides"}, {n: "long", d: "26km", s: "75% at MP"}]
  - ["Yoga", {n: "aerobic", d: "13km", s: "strides"}, {n: "speed", d: "13km", s: "5x800m intervals"}, {n: "recovery", d: "8km"}, "-", {n: "aerobic", d: "13km", s: "strides"}, {n: "long", d: "23km"}]
  - ["Yoga", {n: "recovery", d: "11km", s: "strides"}, {n: "tempo", d: "18km", s: "60% at HMP"}, "-", {n: "long", d: "19km"}, {n: "recovery", d: "8km"}, {n: "long", d: "32km"}]

  - ["Yoga", {n: "speed", d: "13km", s: "5x600m intervals"}, {n: "long", d: "19km"}, "-", {n: "recovery", d: "8km", s: "strides"}, {n: "tune-up", d: "21km"}, {n: "long", d: "27km"}]
  - ["Yoga", {n: "aerobic", d: "13km"}, {n: "speed", d: "14km", s: "5x1000m intervals"}, "-", {n: "long", d: "19km", s: "strides"}, {n: "recovery", d: "8km"}, {n: "long-plus", d: "29km", s: "75% at MP"}]
  - ["Yoga", {n: "speed", d: "13km", s: "5x600m intervals"}, {n: "long", d: "18km"}, "-", {n: "recovery", d: "6km", s: "strides"}, {n: "tune-up", d: "21km"}, {n: "long", d: "27km"}]
  - ["Yoga", {n: "recovery", d: "11km", s: "strides"}, {n: "speed", d: "16km", s: "5x1200m intervals"}, "-", {n: "long", d: "18km"}, {n: "recovery", d: "6km"}, {n: "long", d: "32km"}]

  - ["Yoga", {n: "speed", d: "13km", s: "5x600m intervals"}, {n: "recovery", d: "10km"}, "-", {n: "recovery", d: "6km"}, {n: "tune-up", d: "15km"}, {n: "long", d: "26km"}]
  - ["Yoga", {n: "aerobic", d: "11km", s: "strides"}, {n: "speed", d: "13km", s: "3x1200m intervals"}, "-", {n: "recovery", d: "8km", s: "strides"}, "-", {n: "long", d: "19km"}]
  - ["Yoga", {n: "recovery", d: "10km"}, {n: "aerobic", d: "11km", s: "25% at MP"}, "-", {n: "recovery", d: "8km","strides"}, {n: "recovery", d: "6km"}, {n: "race", d: "42.2km"}]
---
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    table {
      border-collapse: collapse;
    }
    table thead tr:nth-child(1) {
      background: white;
      position: sticky;
      top: 0;
    }
    table tbody tr td {
      vertical-align: middle;
    }
    table tbody tr td:first-child {
      cursor: pointer;
    }
    tr.this-week {
      border-top: black 3px dotted;
      border-bottom: black 3px dotted;
    }
    td.today {
      border-left: black 3px dotted;
      border-right: black 3px dotted;
    }
    td.recovery {
      background-color: #CFE2F3;
    }
    td.aerobic {
      background-color: #FFF2CC;
    }
    td.long {
      background-color: #D9D2E9;
    }
    td.long-plus {
      background-color: #D9D2E9;
    }
    td.tempo {
      background-color: #F4CCCC;
    }
    td.speed {
      background-color: #E6B8AF;
    }
    td.tune-up {
      background-color: #D5A6BD;
    }
    td.race {
      background-color: #D5A6BD;
    }
  </style>

  <title>18 & Change</title>
</head>

<body>
  <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <div class="container-md mb-3">
    <div class="row">
      <div class="col-12 text-center">
        <h1 class="mt-2">18 & Change</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        Non-negotiables:
        <ol>
          <li>STRETCH AFTER EVERY SESSION</li>
          <li>DON'T NEGLECT STRENGTH AND CONDITIONING</li>
          <li>RESPECT THE REST & RECOVERY</li>
        </ol>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-4 col-md-6 col-xs-12 mb-2">
        <form action="javascript:void(0);" class="">
          <div class="form-group d-flex">
            <label for="date" class="col-form-label text-end me-2">Race&nbsp;Date (week&nbsp;of)</label>
            <div class="flex-grow-1">
              <input id="date" name="date" type="date" class="form-control">
            </div>
          </div>
        </form>
      </div>
      <div class="col-lg-4 col-md-6 col-xs-12 mb-2">
        <form action="javascript:void(0);" class="">
          <div class="form-group d-flex">
            <label for="pace" class="col-form-label text-end me-2">Pace</label>
            <div class="flex-grow-1">
              <div class="input-group">
                <input id="pace" name="pace" type="pace" class="form-control">
                <!-- <span class="input-group-text">min/km</span> -->
                <select name="pace-unit" id="pace-unit" class="selectpicker form-control" data-live-search="true">
                  <option value="SecPerKm">/km</option>
                  <option value="SecPerMi">/mi</option>
                  <option value="KmPerHour">km/h</option>
                  <option value="MiPerHour">mi/h</option>
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="col-lg-4 col-md-6 col-xs-12 mb-2">
        <form action="javascript:void(0);" class="">
          <div class="form-group d-flex">
            <label for="maxhr" class="col-form-label text-end me-2">Max&nbsp;HR</label>
            <div class="flex-grow-1">
              <div class="input-group">
                <input id="maxhr" name="maxhr" type="maxhr" class="form-control" placeholder="190">
                <span class="input-group-text">bpm</span>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <table class="table table-bordered table-sm text-center mt-4"
          data-toggle="table" data-sticky-header="true">
          <thead>
            <tr>
              <th scope="col">Week</th>
              <th scope="col">Monday</th>
              <th scope="col">Tuesday</th>
              <th scope="col">Wednesday</th>
              <th scope="col">Thursday</th>
              <th scope="col">Friday</th>
              <th scope="col">Saturday</th>
              <th scope="col">Sunday</th>
            </tr>
          </thead>
          <tbody>
            {%- assign week_num = 1 -%}
            {% for week in page.program -%}
              <tr {%- for divider in page.program_dividers -%}{%- if divider == week_num %} style="border-bottom: solid 2px;"{%- endif -%}{%- endfor -%}>
                <td>#{{ week_num }}</td>
                {%- for day in week -%}
                  {%- if day.d or day.n or day.s -%}
                    <td class="{{- day.n -}}" {%- for hrz in page.hr_zones -%}{%- if hrz[0] == day.n %} data-pace-pct="{{- hrz[1] -}}"{%- endif -%}{%- endfor -%}>
                    {%- if day.n -%}{{- day.n | capitalize -}}<br/>{%- endif -%}
                    {%- if day.d -%}<span data-distance="{{- day.d -}}">{{- day.d -}}</span><br/>{%- endif -%}
                    {%- if day.s -%}<span class="fst-italic">{{- day.s -}}</span>{%- endif -%}

                  {%- elsif day[0] -%}
                    <td>
                    {%- for d in day -%}
                      {{- d -}}
                      {%- unless forloop.last -%}<br/>{%- endunless -%}
                    {%- endfor -%}
                  
                  {%- else -%}
                    <td>
                    {{- day -}}
                  {%- endif -%}
                </td>
                {%- endfor -%}
              </tr>
              {%- assign week_num = week_num | plus: 1 -%}
            {% endfor %}
        </table>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-20">
          <div class="card-body">
            <h5 class="card-title">20:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">5 MINUTE EASY JOG WARM UP</li>
            <li class="list-group-item">10 X 30 SECONDS HARD RUNNING / 30 SECONDS SLOW JOG OR WALK</li>
            <li class="list-group-item">5 MINS EASY COOL DOWN</li>
          </ul>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-30">
          <div class="card-body">
            <h5 class="card-title">30:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">1KM EASY JOG WARM UP</li>
            <li class="list-group-item">5 X 30S EASY/20S TEMPO/10S HARD</li>
            <li class="list-group-item">2 MINS WALK</li>
            <li class="list-group-item">5 X 30S EASY/20S TEMPO/ 10S HARD</li>
            <li class="list-group-item">2 MINS WALK</li>
            <li class="list-group-item">5 X 30S EASY/20S TEMPO/ 10S HARD</li>
            <li class="list-group-item">2 MINS WALK</li>
            <li class="list-group-item">1KM COOL DOWN EASY JOG</li>
          </ul>
        </div>
      </div>  
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-40">
          <div class="card-body">
            <h5 class="card-title">40:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">10 MINUTE EASY JOG WARM UP</li>
            <li class="list-group-item">5 X 3 MINS HARD RUN / 1 MINS SLOW JOG OR WALK</li>
            <li class="list-group-item">10 MINS EASY JOG WALK COOL DOWN</li>
          </ul>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-50">
          <div class="card-body">
            <h5 class="card-title">50:00 intervals</h5>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">10 MINS EASY JOG WARM UP</li>
            <li class="list-group-item">4 X 5 MINS AT TEMPO (7 OR 8/10 RPE) WITH 2.5MINS RECOVERY BETWEEN EACH</li>
            <li class="list-group-item">10 MINS EASY JOG COOL DOWN</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-3 col-md-6 mb-2">
        <div class="card" id="intervals-20">
          <div class="card-body">
            <h5 class="card-title">Strength</h5>
            <p class="card-text">Do each exercise below 5-10 reps &times; 2-3 sets each</p>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">Stair step ups</li>
            <li class="list-group-item">Reverse lunges w/ step through</li>
            <li class="list-group-item">Cossack squats</li>
            <li class="list-group-item">Bulgarian split squats</li>
            <li class="list-group-item">Reverse lunges w/ step through</li>
            <li class="list-group-item">One legged box squats</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <pre>
          TODO: link to pace equivalency calculator for 5km (hard running) time
          (ex: https://lukehumphreyrunning.com/hmmcalculator/race_equivalency_calculator.php)
        </pre>
      </div>
    </div>
  </div>
  <script>
    const PaceUnit = Object.freeze({
      SecPerKm: 0,
      SecPerMi: 1,
      KmPerHour: 2,
      MiPerHour: 3,
    });
    const KM_PER_MI = 1.609344;
    const SEC_PER_HOUR = 60.0 * 60.0;
    const ConvertPace = {
      FromSecPerKm: 0,
      ToSecPerKm: 1,
    };
    ConvertPace[PaceUnit.SecPerKm] = {};
    ConvertPace[PaceUnit.SecPerKm][ConvertPace.FromSecPerKm] = (p) => p;
    ConvertPace[PaceUnit.SecPerKm][ConvertPace.ToSecPerKm] = (p) => p;
    ConvertPace[PaceUnit.SecPerMi] = {};
    ConvertPace[PaceUnit.SecPerMi][ConvertPace.FromSecPerKm] = (p) => p * KM_PER_MI;
    ConvertPace[PaceUnit.SecPerMi][ConvertPace.ToSecPerKm] = (p) => p / KM_PER_MI;
    ConvertPace[PaceUnit.KmPerHour] = {};
    ConvertPace[PaceUnit.KmPerHour][ConvertPace.FromSecPerKm] = (p) => SEC_PER_HOUR / p;
    ConvertPace[PaceUnit.KmPerHour][ConvertPace.ToSecPerKm] = (p) => SEC_PER_HOUR / p;
    ConvertPace[PaceUnit.MiPerHour] = {};
    ConvertPace[PaceUnit.MiPerHour][ConvertPace.FromSecPerKm] = (p) => SEC_PER_HOUR / (p * KM_PER_MI);
    ConvertPace[PaceUnit.MiPerHour][ConvertPace.ToSecPerKm] = (p) => (SEC_PER_HOUR / p) / KM_PER_MI;

    function deserializeDistance(str) {
      const match = str.match(/(\d+(?:\.\d+)?)\s?(km|mi)/);
      if (!match) {
        return null;
      }
      const num = parseFloat(match[1]);
      if (match[2] === "km") {
        return num;
      } else if (match[2] === "mi") {
        return num * KM_PER_MI;
      }

      return null;
    }

    function serializeDistance(distance_in_km, pace_unit) {
      if (pace_unit === PaceUnit.SecPerKm || pace_unit === PaceUnit.KmPerHour) {
        return `${round_to_decimal(distance_in_km, 1)}km`;
      } else {
        return `${round_to_decimal(distance_in_km / KM_PER_MI, 1)}mi`;
      }
    }

    function serializePace(sec_per_km, pace_unit) {
      if (!(pace_unit in Object.values(PaceUnit))) {
        return null;
      }

      const converted = ConvertPace[pace_unit][ConvertPace.FromSecPerKm](sec_per_km);
      if (pace_unit === PaceUnit.SecPerKm || pace_unit === PaceUnit.SecPerMi) {
        return serializeTime(converted);
      }
      else {
        return `${round_to_decimal(converted, 1)}`;
      }
    }

    function deserializePace(str, pace_unit) {
      if (!(pace_unit in Object.values(PaceUnit))) {
        return null;
      }
      let num;
      if (pace_unit === PaceUnit.SecPerKm || pace_unit === PaceUnit.SecPerMi) {
        num = deserializeTime(str);
      }
      else {
        num = parseFloat(str);
      }
      return ConvertPace[pace_unit][ConvertPace.ToSecPerKm](num)
    }

    function displayPaceUnit(pace_unit) {
      const PrettyPaceUnit = {}
      PrettyPaceUnit[PaceUnit.SecPerKm] = "&#8288;/km";
      PrettyPaceUnit[PaceUnit.SecPerMi] = "&#8288;/mi";
      PrettyPaceUnit[PaceUnit.KmPerHour] = "&nbsp;km/h";
      PrettyPaceUnit[PaceUnit.MiPerHour] = "&nbsp;mi/h";
      return PrettyPaceUnit[pace_unit];
    }

    function serializeTime(seconds) {
      if (!Number.isFinite(seconds)) {
        return null;
      }
      
      let t = [];
      const h = Math.floor(seconds / 3600);
      if (h > 0)
        t.push(h);
      const m = Math.floor((seconds % 3600) / 60);
      if (m > 0 || t.length > 0)
        t.push(`${m}`.padStart(1 + (t.length > 0), '0'));
      const s = seconds % 60;
      t.push(`${round_to_decimal(s, 1 - (t.length > 0))}`.padStart(1 + (t.length > 0), '0'));
      return t.join(':');
    }

    function deserializeTime(str) {
      const t = str.split(':');
      return parseFloat(t.pop()||'0') +
        parseInt(t.pop()||'0', 10)*60 +
        parseInt(t.pop()||'0', 10)*3600;
    }

    function swapCountdowns() {
      const program_num_weeks = $("table tbody tr").length;

      for (const el of $('table tbody tr td:first-child')) {
        const $el = $(el);
        const text_match = $el.text().match(/(-|#)?(\d+)/);
        const num = parseInt(text_match[2], 10);
        const inverse_num = program_num_weeks - num;
        if (text_match[1] === '#') {
          $el.text(`${inverse_num == 0 ? '' : '-'}${inverse_num}`);
        } else {
          $el.text(`#${inverse_num}`);
        }
      }
    }

    function updatePace(pace_sec_per_km, pace_unit, maxhr) {
      $("table tbody tr td .distance-addon").remove();

      if (!Number.isFinite(pace_sec_per_km) || !(pace_unit in Object.values(PaceUnit))) {
        return;
      }

      for (const el of $("[data-distance]")) {
        const $el = $(el);
        const pace_pct = parseFloat($el.parents("td").data('pace-pct') || '75');
        const distance_in_km = deserializeDistance($el.data("distance"));
        const adjusted_pace_sec_per_km = pace_sec_per_km * (100.0 / pace_pct);
        const time = distance_in_km * adjusted_pace_sec_per_km;
        let addon = `${serializeTime(Math.ceil(time))}, ${serializePace(Math.ceil(adjusted_pace_sec_per_km), pace_unit)}${displayPaceUnit(pace_unit)}`;
        if (maxhr) {
          addon += `, ❤️&#8288;${Math.ceil(maxhr * (pace_pct / 100.0))}`;
        }
        
        // TODO: this replaces the entire text node, not just the match
        $el.html(`${serializeDistance(distance_in_km, pace_unit)}<span class="distance-addon"> (${addon})</span>`);
      }
    }

    function updateHighlight(date) {
      $(".today, .this-week").removeClass("today").removeClass("this-week");
      
      if (!(date instanceof Date)) {
        return;
      } 

      const now = new Date();
      const program_num_weeks = $("table tbody tr").length;
      const next_monday_after_date = addDays(date, 7 - mod(date.getDay()-1, 7));
      const program_start_ts = next_monday_after_date.getTime() - (program_num_weeks * 1000 * 60 * 60 * 24 * 7);
      const elapsed_days = (now.getTime() - program_start_ts) / (1000 * 60 * 60 * 24);
      const elapsed_weeks = Math.ceil(elapsed_days / 7);
      const elapsed_dow = Math.floor(elapsed_days) % 7;

      if (elapsed_days < 0 || elapsed_weeks > program_num_weeks) {
        return;
      }

      const $this_week = $(`table tbody tr:nth-child(${elapsed_weeks})`).addClass("this-week");
      $this_week.find(`td:nth-child(${elapsed_dow+2})`).addClass("today");
    }

    function round_to_decimal(v, d) {
      return +v.toFixed(d);
    }

    function mod(v, m) {
      return ((v % m) + m) % m;
    }

    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    function deserializeDate(str) {
      const [year, month, date] = str.split("-");
      return new Date(year, month - 1, date);
    }

    function setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + (exdays*24*60*60*1000));
      let expires = "expires="+ d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return null;
    }

    // $(function() {
      "use strict";

      const date_cookie = getCookie("date");
      const pace_cookie = getCookie("pace");
      const pace_unit_cookie = getCookie("pace_unit");
      const maxhr_cookie = getCookie("maxhr");
      let date = null;
      let pace_sec_per_km = null;
      let pace_unit = 0;
      let maxhr = null;

      if (getCookie("countdown") === "true") {
        swapCountdowns();
      }

      if (date_cookie) {
        $('#date').val(date_cookie);
        date = deserializeDate(date_cookie);
      }

      if (pace_unit_cookie) {
        $('#pace-unit').val(pace_unit_cookie);
        pace_unit = PaceUnit[pace_unit_cookie];
      }

      if (pace_cookie) {
        pace_sec_per_km = deserializePace(pace_cookie, pace_unit);
        $('#pace').val(serializePace(pace_sec_per_km, pace_unit));
      }

      if (maxhr_cookie) {
        $('#maxhr').val(maxhr_cookie);
        maxhr = parseInt(maxhr_cookie, 10);
      }

      $('#date').on('change', function() {
        const date_str = $(this).val();
        date = deserializeDate(date_str);
        setCookie('date', date_str, 365);
        updateHighlight(date);
      });

      $('#pace').on('change', function() {
        const pace_str = $(this).val();
        pace_sec_per_km = deserializePace(pace_str, pace_unit);
        if (!Number.isFinite(pace_sec_per_km)) {
          console.error(`Failed to deserialize pace string: ${pace_str}`);
          return;
        }
        setCookie('pace', pace_str, 365);
        updatePace(pace_sec_per_km, pace_unit, maxhr);
      });

      $('#pace-unit').on('change', function() {
        const pace_unit_str = $(this).val();
        if (!(pace_unit_str in PaceUnit)) {
          console.error(`${pace_unit_str} not one of ${Object.keys(PaceUnit)}`);
          return;
        }
        old_pace_unit = pace_unit;
        pace_unit = PaceUnit[pace_unit_str];
        if (pace_unit === old_pace_unit) {
          return;
        }
        setCookie('pace_unit', pace_unit_str, 365);
        updatePace(pace_sec_per_km, pace_unit, maxhr);
        $('#pace').val(serializePace(pace_sec_per_km, pace_unit)).trigger('change');
      });

      $('#maxhr').on('change', function() {
        const maxhr_str = $(this).val();
        maxhr = parseInt(maxhr_str, 10);
        if (isNaN(maxhr)) {
          console.error(`Failed to deserialize maxhr string: ${maxhr_str}`);
          return;
        }
        setCookie('maxhr', maxhr_str, 365);
        updatePace(pace_sec_per_km, pace_unit, maxhr);
      });

      $('table tbody tr td:first-child').on('click', () => {
        setCookie("countdown", getCookie("countdown") == "false", 365);
        swapCountdowns();
      });

      setInterval(function () {
        updateHighlight(date);
      }, 1000 * 60 * 60); // repeat every hour
      
      if (date != null) {
        updateHighlight(date);
      }
      if (pace_sec_per_km !== null && maxhr !== null) {
        updatePace(pace_sec_per_km, pace_unit, maxhr);
      }
    // });
  </script>
</body>

</html>